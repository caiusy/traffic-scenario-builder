# 车辆轨迹编辑器 V2 - 新功能说明

## 🎉 已完成的功能更新

### 1. ✅ 修复添加文字闪退问题
- 文字标注功能现已稳定
- 可以自由添加多个文字标注

### 2. ✅ 文字、摄像头、车辆可拖动
- **文字拖动**：直接拖动文字到任意位置
- **摄像头拖动**：拖动摄像头图标调整位置
- **车辆初始位置拖动**：
  - 当车辆没有轨迹或只有起点时，可以拖动车辆
  - 拖动会自动更新起始轨迹点位置

### 3. ✅ 深色背景 + 可配置左侧留白
- **深色背景**：场景采用深灰色背景 (RGB: 30, 30, 30)
- **左侧留白区域**：默认 200px，可在右侧"场景设置"中调整
  - 范围：0-500px
  - 调整留白会自动移动所有元素（道路、车辆、摄像头、文字）
  - 留白区域可用于添加文字注释

### 4. ✅ 车辆初始可拖动定位
- 添加车辆后，在没有设置轨迹前，车辆可自由拖动
- 拖动车辆会自动创建第一个轨迹点（起点）
- 有轨迹后，车辆沿轨迹移动（不可拖动）

### 5. ✅ 车辆运动逻辑 + 停留时长支持
- **改进的运动插值算法**：
  - 车辆在轨迹点之间平滑移动
  - 支持在轨迹点停留指定时长
  - 停留期间车辆保持静止
  - 停留结束后继续移动到下一个点

### 6. ✅ 轨迹点停留时长设置UI
- 添加轨迹点时，弹出对话框可设置：
  - **到达时间**：车辆到达该点的时间（秒）
  - **停留时长**：在该点停留的时间（秒）
- 默认停留时长为 0 秒（直接通过）
- 可设置 0-10 秒的停留时长

### 7. ✅ 添加道路时界面自适应缩放
- 添加新道路后，视图自动调整缩放
- 确保所有道路都在可见范围内
- 自动计算并适应场景大小

---

## 🚀 使用指南

### 启动编辑器
```bash
cd vehicle_trajectory_editor
python3 vehicle_editor_v2.py
```

### 基本工作流程

#### 1. 设置场景
- 在右侧"场景设置"中调整"左侧留白"（默认 200px）

#### 2. 添加道路
- 点击左侧"➕ 添加道路"
- 道路会自动堆叠在下方
- 视图会自动缩放以适应所有道路

#### 3. 添加车辆
- 在左侧"车辆素材"列表中选择车辆类型（如 YELLOW 车辆）
- 点击"➕ 添加车辆到场景"
- 车辆会出现在场景中
- **拖动车辆**到合适的起始位置

#### 4. 编辑车辆轨迹
- 在右侧"轨迹编辑"中选择车辆
- 调整"车辆大小"（缩放比例）
- 点击"✏️ 编辑轨迹"按钮
- 在场景中点击添加轨迹点：
  - 设置"到达时间"（如 0s, 1s, 2s...）
  - 设置"停留时长"（如在路口停留 2 秒）
- 点击"🗑️ 清除轨迹"可重新规划

#### 5. 添加摄像头
- 点击左侧"➕ 添加摄像头"
- **拖动摄像头**到目标位置

#### 6. 添加文字标注
- 点击左侧"➕ 添加文字"
- 输入文字内容
- **拖动文字**到合适位置
- 在右侧"文字编辑"中可调整：
  - 字体大小（8-72）
  - 颜色

#### 7. 播放动画
- 点击"▶ 播放"查看车辆轨迹动画
- 播放时轨迹线会自动隐藏
- 暂停时轨迹线重新显示
- 拖动时间轴可跳转到指定时间

#### 8. 导出
- **保存项目**：💾 保存项目（JSON 格式）
- **导出视频**：🎬 导出视频（MP4 格式）

---

## 📋 快捷功能说明

### 拖动功能
| 元素类型 | 何时可拖动 | 说明 |
|---------|-----------|------|
| 文字 | 始终 | 拖动文字到任意位置 |
| 摄像头 | 始终 | 拖动调整摄像头位置 |
| 车辆 | 无轨迹或仅起点 | 拖动设置起始位置 |
| 车辆 | 有完整轨迹 | 不可拖动，沿轨迹移动 |

### 轨迹点停留示例
```
轨迹点 1: (100, 200) @ 0s, 停留 0s
轨迹点 2: (300, 200) @ 2s, 停留 1s  ← 在此停留 1 秒
轨迹点 3: (500, 200) @ 5s, 停留 0s

时间线：
- 0s-2s: 从点1移动到点2
- 2s-3s: 在点2停留
- 3s-5s: 从点2移动到点3
```

### 左侧留白用途
- 留白区域为深色背景
- 可在此添加文字说明、标题、图例等
- 调整留白宽度时，所有元素会自动平移

---

## 🎯 提示与技巧

1. **推荐工作流**：
   - 先设置左侧留白宽度
   - 添加道路
   - 添加车辆并拖动到起点
   - 编辑轨迹（记得设置停留时长）
   - 添加摄像头和文字说明
   - 播放预览
   - 导出视频

2. **轨迹编辑提示**：
   - 第一个点的时间通常设为 0s
   - 时间必须递增
   - 路口/停车点可设置停留时长（如 1-3 秒）

3. **视图调整**：
   - 添加道路后会自动缩放
   - 可使用鼠标滚轮缩放视图
   - 拖动空白区域可平移视图

4. **性能优化**：
   - 导出视频时会隐藏轨迹线
   - 较长动画建议分段导出

---

## 🐛 已知问题

- 无

---

## 📞 技术支持

如有问题，请检查：
1. 素材是否正确加载（启动时会显示统计信息）
2. Python 环境是否包含所需依赖：PyQt6, OpenCV, NumPy
3. 轨迹点时间是否按递增顺序设置

祝使用愉快！ 🎉
